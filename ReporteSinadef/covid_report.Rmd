---
title: "Seguimiento del número de fallecimientos diarios en el Perú"
subtitle: "Datos del Sistema Informático Nacional de Defunciones, SINADEF"
author: "Raúl Eyzaguirre"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: html_document
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

options(stringsAsFactors = FALSE)
options(digits = 4)

library(ggplot2)
library(ggrepel)
library(st4gi)
library(reshape)
library(readxl)
library(httr)

```

```{r datos, include = FALSE}

# Leer datos

url.sinadef <- "https://cloud.minsa.gob.pe/s/NctBnHXDnocgWAg/download?path=%2F&files=SINADEF_DATOS_ABIERTOS_29062020.xlsx"
GET(url.sinadef, write_disk("temp.xlsx", overwrite = TRUE))
full <- data.frame(read_excel("temp.xlsx", sheet = 1, skip = 3))
full <- full[, c("SEXO", "EDAD", "TIEMPO.EDAD", "NIVEL.DE.INSTRUCCIÓN", "PAIS.DOMICILIO",
                 "PROVINCIA.DOMICILIO", "DISTRITO.DOMICILIO", "FECHA", "AÑO", "MES",
                 "MUERTE.VIOLENTA")]
colnames(full) <- c("sexo", "edad", "unidad", "educa", "pais", "provincia",
                    "distrito", "fecha", "ano", "mes", "violenta")

# Formato fecha

full$fecha <- as.Date(full$fecha, "%Y-%m-%d")
full$mes <- as.numeric(full$mes)
full$ano <- as.numeric(full$ano)

# Codificar semanas

full$semana <- as.numeric(strftime(full$fecha, format = "%V"))

# Eliminar otros paises

full <- full[full$pais == "PERU", ]

# Identificar ultimo dia

ultimo.fecha <- max(full$fecha)
ultimo.dia <- as.numeric(substr(ultimo.fecha, 9, 10)) - 1 
ultimo.mes <- as.numeric(substr(ultimo.fecha, 6, 7))

ultimo.mes.texto <- c("enero", "febrero", "marzo", "abril", "mayo", "junio",
                      "julio", "agosto", "septiembre", "octubre", "noviembre",
                      "diciembre")[ultimo.mes]

# Diferencias 2017, 2018, 2019

tt <- table(full$ano)
dif17.19 <- (tt[3] - tt[1]) / tt[3] * 100
dif18.19 <- (tt[3] - tt[2]) / tt[3] * 100

# Conteo por año y provincia

prov.ano <- table(full$provincia, full$ano)
chcy <- prov.ano[rownames(prov.ano) == "CHICLAYO", ]
ferr <- prov.ano[rownames(prov.ano) == "FERREÑAFE", ]
lamb <- prov.ano[rownames(prov.ano) == "LAMBAYEQUE", ]

# Datos hasta el último día de todos los años

full <- full[full$mes <= ultimo.mes, ]
full <- full[!(full$mes == ultimo.mes & as.numeric(substr(full$fecha, 9, 10)) > ultimo.dia), ]

# Juntar Lima y Callao

full$prov2 <- full$provincia
full$prov2[full$prov2 %in% c("CALLAO", "LIMA")] <- "LIMA Y CALLAO"

# Eliminar muerte violenta

full.nv <- full[full$violenta == "SIN REGISTRO", ]

```

## 1. Introducción

Los datos del sistema Informático Nacional de Defunciones, SINADEF, pueden descargarse desde [este enlace](http://www.minsa.gob.pe/reunis/data/defunciones_registradas.asp) y cuentan con el registro de defunciones desde el año 2017. En la circunstancia actual, estos datos permiten evaluar el efecto de la epidemia de COVID-19 en el país. Es importante tener en cuenta que podría haber un efecto de cobertura (o falta de cobertura) en los años 2017 y 2018, en donde el número de fallecidos es un `r paste0(format(dif17.19, digits = 3), "%")` y `r paste0(format(dif18.19, digits = 3), "%")` menor que en el 2019 respectivamente. Por esta razón solo se utilizarán como referencia los datos del 2018 y el 2019.

### Problemas con los datos

Las provincias de Chiclayo, Ferreñafe y Lambayeque presentan una disminución considerable en el número de fallecidos con respecto al 2017. En la siguiente tabla se ve el número total de fallecidos en estas tres provincias en los años 2017, 2018 y 2019.

| Provincia  | Total fallecidos 2017 | Total fallecidos 2018 | Total fallecidos 2019 |
|:-----------|:---------------------:|:---------------------:|:---------------------:|
| Chiclayo   | `r chcy[1]`           |`r chcy[2]`            |`r chcy[3]`            |
| Ferreñafe  | `r ferr[1]`           |`r ferr[2]`            |`r ferr[3]`            |
| Lambayeque | `r lamb[1]`           |`r lamb[2]`            |`r lamb[3]`            |

## 2. Número total de fallecimientos por año

Los siguientes gráficos permiten evaluar el efecto COVID-19; el primero en el sentido más amplio pues incluye, entre otros factores:

- El incremento en el número de fallecimientos debido a COVID-19.
- El incremento en el número de fallecimientos debido a otras enfermedades que quedan desatendidas en el contexto actual.
- La disminución en el número de fallecimientos por causas violentas como los accidentes de tránsito.

El segundo gráfico no considera el posible efecto positivo en la disminución del número de muertes violentas.

```{r barras_total}

# Conteo por año

totales <- table(full$ano)

# Grafico de barras

xx <- barplot(height = totales,
              las = 1, xlab = "Año", ylim = c(0, max(totales)*1.1),
              main = paste("Número de fallecidos registrados total a nivel nacional
hasta el", ultimo.dia, "de", ultimo.mes.texto))

text(x = xx, y = totales, label = totales, pos = 3, cex = 0.8)

```

La diferencia a la fecha entre este año y el 2019 es de `r totales[4] - totales[3]` para el número total de fallecidos.

```{r barras_nv}

# Conteo por año

totales <- table(full.nv$ano)

# Grafico de barras

xx <- barplot(height = totales,
              las = 1, xlab = "Año", ylim = c(0, max(totales)*1.1),
              main = paste("Número de fallecidos por causa no violenta registrados
a nivel nacional hasta el", ultimo.dia, "de", ultimo.mes.texto))

text(x = xx, y = totales, label = totales, pos = 3, cex = 0.8)

```

La diferencia a la fecha entre este año y el 2019 es de `r totales[4] - totales[3]` para el número de fallecidos por causa no violenta.

## 3. Evolución del número de fallecidos diarios por causa no violenta en el 2020

Los siguientes gráficos permiten evaluar la evolución de la epidemia a través de su efecto en el número de fallecimientos diarios por causa no violenta, a nivel nacional y en las provincias con mayor población.

```{r tendencias}

# Solo año 2020

temp <- full.nv[full.nv$ano == 2020, ]

## Total nacional

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')

# Gráfico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios a nivel nacional por causa no violenta") +
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))
#  xlim(as.Date.numeric(0, "2020-01-01"), as.Date.numeric(dim(ds)[1] + 10, "2020-01-01")) +
#  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'), fullrange = TRUE)

## Lima y Callao

temp.p <- temp[temp$provincia %in% c("CALLAO", "LIMA"), ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en las provincias de Lima y Callao por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))
#   xlim(as.Date.numeric(0, "2020-01-01"), as.Date.numeric(dim(ds)[1] + 31, "2020-01-01")) +
#   geom_smooth(data = ds[ds$fecha < "2020-06-23", ], method = 'gam', formula = y ~ s(x, bs = 'cr'), fullrange = TRUE, color = 2) + # rojo
#   geom_smooth(data = ds[ds$fecha < "2020-06-29", ], method = 'gam', formula = y ~ s(x, bs = 'cr'), fullrange = TRUE, color = 4) # azul

## Arequipa

temp.p <- temp[temp$provincia == "AREQUIPA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Arequipa por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Trujillo

temp.p <- temp[temp$provincia == "TRUJILLO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Trujillo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Chiclayo

temp.p <- temp[temp$provincia == "CHICLAYO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Chiclayo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Piura

temp.p <- temp[temp$provincia == "PIURA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Piura por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Huancayo

temp.p <- temp[temp$provincia == "HUANCAYO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huancayo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Maynas

temp.p <- temp[temp$provincia == "MAYNAS", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Maynas por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Cusco

temp.p <- temp[temp$provincia == "CUSCO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Cusco por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Santa

temp.p <- temp[temp$provincia == "SANTA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Santa por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Ica

temp.p <- temp[temp$provincia == "ICA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Ica por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Coronel Portillo

temp.p <- temp[temp$provincia == "CORONEL PORTILLO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Coronel Portillo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Cajarmarca

temp.p <- temp[temp$provincia == "CAJAMARCA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Cajamarca por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Sullana

temp.p <- temp[temp$provincia == "SULLANA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Sullana por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## San Román

temp.p <- temp[temp$provincia == "SAN ROMAN", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de San Román por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Tacna

temp.p <- temp[temp$provincia == "TACNA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Tacna por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Lambayeque

temp.p <- temp[temp$provincia == "LAMBAYEQUE", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Lambayeque por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Huanuco

temp.p <- temp[temp$provincia == "HUANUCO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huánuco por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Huamanga

temp.p <- temp[temp$provincia == "HUAMANGA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huamanga por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Cañete

temp.p <- temp[temp$provincia == "CAÑETE", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Cañete por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Huaura

temp.p <- temp[temp$provincia == "HUAURA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huaura por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Chincha

temp.p <- temp[temp$provincia == "CHINCHA", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Chincha por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Puno

temp.p <- temp[temp$provincia == "PUNO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Puno por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Satipo

temp.p <- temp[temp$provincia == "SATIPO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Satipo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## San Martín

temp.p <- temp[temp$provincia == "SAN MARTIN", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de San Martín por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Jaen

temp.p <- temp[temp$provincia == "JAEN", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Jaen por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Huaral

temp.p <- temp[temp$provincia == "HUARAL", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huaral por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Huaraz

temp.p <- temp[temp$provincia == "HUARAZ", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huaraz por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Morropon

temp.p <- temp[temp$provincia == "MORROPON", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Morropón por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Tumbes

temp.p <- temp[temp$provincia == "TUMBES", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Tumbes por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Chanchamayo

temp.p <- temp[temp$provincia == "CHANCHAMAYO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Chanchamayo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

## Pisco

temp.p <- temp[temp$provincia == "PISCO", ]

# Conteo diario

ds <- docomp("count", "pais", "fecha", dfr = temp.p, method = 'slow')

# Grafico

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Pisco por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

```

## 4. Provincias y distritos con mayor incremento de fallecidos por causa no violenta en el último mes

En los siguientes gráficos se observan las 20 provincias y 40 distritos con mayor incremento de fallecimientos por causa no violenta en el último mes con respecto a la media del mismo periodo en el 2018 y 2019. Estos gráficos permiten identificar las provincias y distritos en los que la enfermedad podría haber avanzado más. Para evitar el efecto de muestras pequeñas, solo se consideran las provincias y distritos con un promedio de fallecimientos mensual mayor a 10 en la media del 2018 y 2019.

```{r provincias, fig.width = 7.5, fig.height = 5}

# Seleccionar ultimo mes

temp <- full.nv[full.nv$mes %in% c(ultimo.mes - 1, ultimo.mes), ]
temp <- temp[!(temp$mes == (ultimo.mes - 1) & as.numeric(substr(temp$fecha, 9, 10)) < ultimo.dia), ]

# Conteo diario provincia

ds <- docomp("count", "pais", c("ano", "prov2"), dfr = temp, method = 'slow')

# Datos por año

dc <- ds[ds$ano == 2020, 2:3]
colnames(dc)[2] <- "total20"
temp.p <- ds[ds$ano == 2019, 2:3]
colnames(temp.p)[2] <- "total19"
dc <- merge(dc, temp.p)
temp.p <- ds[ds$ano == 2018, 2:3]
colnames(temp.p)[2] <- "total18"
dc <- merge(dc, temp.p)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Ordenar y eliminar provincias con pocos habitantes

dc <- dc[dc$media1819 > 10, ]
dc <- dc[sort.int(dc$ratio, index.return = TRUE)$ix, ]
dc <- dc[(dim(dc)[1] - 19):dim(dc)[1], ]

# Grafico provincia

par(mar = c(4, 15, 2, 2) + 0.2)
barplot(height = dc$ratio, names.arg = dc$prov2, horiz = TRUE, las = 1,
        main = "Provincias con mayor incremento de fallecidos
en el último mes",
        xlab = "Cociente entre fallecidos por causa no violenta
en 2020 y la media 2018-2019 en el último mes")

```

```{r distritos, fig.width = 8, fig.height = 9}

# Conteo diario Distrito

ds <- docomp("count", "pais", c("ano", "distrito"), "provincia", dfr = temp, method = 'slow')
ds$distrito <- paste(ds$distrito, ds$provincia, sep = " / ")

# Datos por año

dc <- ds[ds$ano == 2020, 2:4]
colnames(dc)[3] <- "total20"
temp.p <- ds[ds$ano == 2019, 2:4]
colnames(temp.p)[3] <- "total19"
dc <- merge(dc, temp.p)
temp.p <- ds[ds$ano == 2018, 2:4]
colnames(temp.p)[3] <- "total18"
dc <- merge(dc, temp.p)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Ordenar y eliminar distritos con pocos habitantes

dc <- dc[dc$media1819 > 10, ]
dc <- dc[sort.int(dc$ratio, index.return = TRUE)$ix, ]
dc <- dc[(dim(dc)[1] - 39):dim(dc)[1], ]

# Grafico distrito

par(mar = c(4, 19, 2, 2) + 0.2)
barplot(height = dc$ratio, names.arg = dc$distrito, horiz = TRUE, las = 1,
        main = "Distritos con mayor incremento de fallecidos
en el último mes",
        xlab = "Cociente entre fallecidos por causa no violenta
en 2020 y la media 2018-2019 en el último mes")

```

## 5. Exceso de fallecidos con respecto a la media de los años 2018 y 2019 por cada 1000 habitantes

Si evaluamos el exceso de fallecidos este año con respecto a la media de los años 2018 y 2019 y lo presentamos como número de fallecidos por mil habitantes, podemos tener un indicador del avance de la enfermedad en el país y por provincia. En los gráficos de la sección 3 se puede identificar a ciertas provincias que ya habrían pasado por el pico para el número de fallecidos diarios, luego, el valor para el número de fallecidos por mil habitantes para estas provincias podría servir como un referente en relación con el pico de la enfermedad.

```{r exceso}

# Conteo diario provincia y año

ds <- docomp("count", "pais", c("ano", "prov2"), dfr = full.nv, method = 'slow')

# Datos por año

dc <- ds[ds$ano == 2020, 2:3]
colnames(dc)[2] <- "total20"
temp.p <- ds[ds$ano == 2019, 2:3]
colnames(temp.p)[2] <- "total19"
dc <- merge(dc, temp.p)
temp.p <- ds[ds$ano == 2018, 2:3]
colnames(temp.p)[2] <- "total18"
dc <- merge(dc, temp.p)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Diferencia

dc$dif <- dc$total20 - dc$media1819

#| Chiclayo         | `r dc[dc$prov2 == "CHICLAYO", "dif"] / 799675 * 1000` | 
#| Lambayeque       | `r dc[dc$prov2 == "LAMBAYEQUE", "dif"] / 300170 * 1000` | 
#| Ica              | `r dc[dc$prov2 == "ICA", "dif"] / 391519 * 1000` | 
#| Pasco            | `r dc[dc$prov2 == "PASCO", "dif"] /	123015 * 1000` | 
#| Sechura          | `r dc[dc$prov2 == "SECHURA", "dif"] /	79177 * 1000` | 
#| Huaral           | `r dc[dc$prov2 == "HUARAL", "dif"] / 183898 * 1000` | 
#| San Martin       | `r dc[dc$prov2 == "SAN MARTIN", "dif"] / 193095 * 1000` | 
#| Viru             | `r dc[dc$prov2 == "VIRU", "dif"] / 92324 * 1000` | 
#| Pisco            | `r dc[dc$prov2 == "PISCO", "dif"] / 150744 * 1000` | 
#| Leoncio Prado    | `r dc[dc$prov2 == "LEONCIO PRADO", "dif"] / 127793 * 1000` | 
#| Jaen             | `r dc[dc$prov2 == "JAEN", "dif"] / 185432 * 1000` | 
#| Huaura           | `r dc[dc$prov2 == "HUAURA", "dif"] / 227685 * 1000` | 
#| Requena          | `r dc[dc$prov2 == "REQUENA", "dif"] /	58511 * 1000` | 
#| Alto Amazonas    | `r dc[dc$prov2 == "ALTO AMAZONAS", "dif"] /	122725 * 1000` | 

```

En la siguiente tabla se muestra el exceso de fallecidos en el 2020 con respecto a la media del 2018 y 2019 expresado en proporción por cada mil para algunas provincias y para el total nacional. Para la población total en todos los casos se toma como referencia la población registrada en [censo del 2017](https://es.wikipedia.org/wiki/Anexo:Provincias_del_Perú).

| Provincia        | Exceso de fallecidos por 1000 habitantes |
|:-----------------|:----------------------------------------:|
| Chincha          | `r dc[dc$prov2 == "CHINCHA", "dif"] / 226113 * 1000` | 
| Tumbes           | `r dc[dc$prov2 == "TUMBES", "dif"] / 154962 * 1000` |
| Lima y Callao    | `r dc[dc$prov2 == "LIMA Y CALLAO", "dif"] / 9569468 * 1000` |
| Santa            | `r dc[dc$prov2 == "SANTA", "dif"] / 435807 * 1000` | 
| Coronel Portillo | `r dc[dc$prov2 == "CORONEL PORTILLO", "dif"] / 384168 * 1000` |
| Casma            | `r dc[dc$prov2 == "CASMA", "dif"] /	50989 * 1000` | 
| Zarumilla        | `r dc[dc$prov2 == "ZARUMILLA", "dif"] / 48844 * 1000` | 
| Maynas           | `r dc[dc$prov2 == "MAYNAS", "dif"] / 479866 * 1000` |
| Huarochiri       | `r dc[dc$prov2 == "HUAROCHIRI", "dif"] / 58145 * 1000` | 
| Paita            | `r dc[dc$prov2 == "PAITA", "dif"] / 129892 * 1000` | 
| Trujillo         | `r dc[dc$prov2 == "TRUJILLO", "dif"] / 970016 * 1000` | 
| Tambopata        | `r dc[dc$prov2 == "TAMBOPATA", "dif"] / 111474 * 1000` | 
| Piura            | `r dc[dc$prov2 == "PIURA", "dif"] / 799321 * 1000` | 
| Sullana          | `r dc[dc$prov2 == "SULLANA", "dif"] / 311454 * 1000` | 
| Total nacional   | `r (totales[4] - totales[3]) / 31237385 * 1000` |

## 6. Efecto COVID-19 y altura

En el siguiente gráfico se observa la relación entre el exceso en el número de fallecidos con respecto a la media del 2018 y 2019 en casos por 1000 habitantes para las provincias más pobladas y la altitud de la ciudad más poblada de la provincia. Ya se sabe que existe un importante factor protector debido a la altura. Se consideran todas las provincias con más de 150 mil habitantes con la excepción de Chiclayo y Lambayeque (por las razones expuestas en la sección 1 de este documento).

```{r altura}

prov <- c("Lima y Callao", "Arequipa", "Trujillo", "Piura", "Huancayo", "Maynas",
          "Cusco", "Santa", "Ica", "Coronel Portillo", "Cajamarca", "Sullana",
          "San Román", "Tacna", "Huánuco", "Huamanga", "Cañete", "Huaura",
          "Chincha", "Puno", "Satipo", "San Martín", "Jaen", "Huaral", "Huaraz",
          "Morropón", "Tumbes", "Chanchamayo", "Pisco")
exce <- c(dc[dc$prov2 == "LIMA Y CALLAO", "dif"] / 9569468 * 1000,
          dc[dc$prov2 == "AREQUIPA", "dif"] / 1080635 * 1000,
          dc[dc$prov2 == "TRUJILLO", "dif"] / 970016 * 1000,
          dc[dc$prov2 == "PIURA", "dif"] / 799321 * 1000,
          dc[dc$prov2 == "HUANCAYO", "dif"] / 545615 * 1000,
          dc[dc$prov2 == "MAYNAS", "dif"] / 479866 * 1000,
          dc[dc$prov2 == "CUSCO", "dif"] / 447588 * 1000,
          dc[dc$prov2 == "SANTA", "dif"] / 435807 * 1000,
          dc[dc$prov2 == "ICA", "dif"] / 391519 * 1000,
          dc[dc$prov2 == "CORONEL PORTILLO", "dif"] / 384168 * 1000,
          dc[dc$prov2 == "CAJAMARCA", "dif"] / 348433 * 1000,
          dc[dc$prov2 == "SULLANA", "dif"] / 311454 * 1000,
          dc[dc$prov2 == "SAN ROMAN", "dif"] / 307417 * 1000,
          dc[dc$prov2 == "TACNA", "dif"] / 306363 * 1000,
          dc[dc$prov2 == "HUANUCO", "dif"] / 293397 * 1000,
          dc[dc$prov2 == "HUAMANGA", "dif"] / 282194 * 1000,
          dc[dc$prov2 == "CAÑETE", "dif"] / 240013 * 1000,
          dc[dc$prov2 == "HUAURA", "dif"] / 227685 * 1000,
          dc[dc$prov2 == "CHINCHA", "dif"] / 226113 * 1000,
          dc[dc$prov2 == "PUNO", "dif"] / 219494 * 1000,
          dc[dc$prov2 == "SATIPO", "dif"] / 203985 * 1000,
          dc[dc$prov2 == "SAN MARTIN", "dif"] / 193095 * 1000,
          dc[dc$prov2 == "JAEN", "dif"] / 185432 * 1000,
          dc[dc$prov2 == "HUARAL", "dif"] / 183898 * 1000,
          dc[dc$prov2 == "HUARAZ", "dif"] / 163936 * 1000,
          dc[dc$prov2 == "MORROPON", "dif"] / 162027 * 1000,
          dc[dc$prov2 == "TUMBES", "dif"] / 154962 * 1000,
          dc[dc$prov2 == "CHANCHAMAYO", "dif"] / 151489 * 1000,
          dc[dc$prov2 == "PISCO", "dif"] / 150744 * 1000)
alti <- c(161, 2335, 34, 36, 3246, 105, 3399, 5, 406, 154, 2750, 65, 3824,
          562, 1898, 2761, 40, 30, 97, 3810, 631, 350, 729, 188, 3052, 92,
          6, 751, 17)

temp <- data.frame(provincia = prov,
                   exceso = exce,
                   altitud = alti)

ggplot(temp, aes(alti, exce)) +
  geom_point() +
  labs(x = "Altitud de la ciudad más poblada (m s.n.m.)",
       y = "Exceso de fallecidos por 1000 habitantes",
       title = "Exceso de fallecidos por 1000 habitantes para el año 2020 con respecto
a la media 2018-2019 para las provincias más pobladas con relación a su altitud") + 
  geom_text_repel(label = prov) +
  geom_smooth(method = "lm", se = FALSE)

```

## 7. Evolución del número de fallecidos diarios por causa no violenta en el 2020 por sexo, edad, y nivel de instrucción

Se sabe que la letalidad de COVID-19 es mayor en hombres que en mujeres y que se incrementa considerablemente con la edad. Se observa también diferencias entre grupos con diferente nivel de instrucción, aunque este efecto podría estar confundido con el sexo, la edad y la zona de residencia (urbano o rural). Los siguientes gráficos permiten evaluar el efecto de la epidemia por sexo, edad y nivel de instrucción en el Perú.

```{r sexo}

# Limpiar solo hombres y mujeres

temp <- full.nv[full.nv$sexo == "FEMENINO" | full.nv$sexo == "MASCULINO", ]

# Conteo diario

ds <- docomp("count", "pais", c("fecha", "sexo"), "ano", dfr = temp, method = 'slow')

# Formato

ds$mes <- substr(as.character(ds$fecha), 6, 7)
ds$dia <- substr(as.character(ds$fecha), 9, 10)

# Datos por año

dc <- ds[ds$ano == 2020, -3]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019, c(2, 4, 5, 6)]
colnames(temp)[2] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018, c(2, 4, 5, 6)]
colnames(temp)[2] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Diferencia y ratio

dc$dif <- dc$total20 - dc$media1819
dc$ratio <- dc$total20 / dc$media1819

# Grafico

dc$sexo[dc$sexo == "MASCULINO"] <- "Masculino"
dc$sexo[dc$sexo == "FEMENINO"] <- "Femenino"

niveles <- c("Masculino", "Femenino")
dc$Sexo <- factor(dc$sexo, levels = niveles, ordered = TRUE)

ggplot(dc, aes(fecha, ratio, colour = Sexo)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Cociente entre el año 2020 y la media 2018-2019",
       title = "Número de fallecidos diarios a nivel nacional por causa no violenta según sexo") + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

```

```{r edad}

# Limpiar solo edad en anos

temp <- full.nv[full.nv$unidad == "AÑOS", ]

# Grupos

temp$grupo <- "Mayor de 75"
temp$grupo[temp$edad < 75] <- "65 a 75"
temp$grupo[temp$edad < 65] <- "55 a 65"
temp$grupo[temp$edad < 55] <- "45 a 55"
temp$grupo[temp$edad < 45] <- "35 a 45"
temp$grupo[temp$edad < 35] <- "Menor de 35"

# Conteo diario

ds <- docomp("count", "pais", c("semana", "grupo", "ano"), dfr = temp, method = 'slow')

# Datos por año

dc <- ds[ds$ano == 2020, -3]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019, c(1, 2, 4)]
colnames(temp)[3] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018, c(1, 2, 4)]
colnames(temp)[3] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Eliminar última semana

dc <- dc[dc$semana < max(dc$semana), ]

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Grafico

niveles <- c("55 a 65", "65 a 75", "45 a 55", "35 a 45", "Mayor de 75", "Menor de 35")
dc$`Grupo de edad` <- factor(dc$grupo, levels = niveles, ordered = TRUE)

ggplot(dc, aes(semana, ratio, colour = `Grupo de edad`)) +
  geom_point() +
  labs(x = "Semana",
       y = "Cociente entre el año 2020 y la media 2018-2019",
       name = "Grupo de Edad",
       title = "Número de fallecidos semanales a nivel nacional por causa no violenta
según grupo de edad") + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

```

```{r instrucción}

# Limpiar solo instrucción definida

temp <- full.nv[!(full.nv$educa == "IGNORADO" | full.nv$educa == "SIN REGISTRO"), ]

# Grupos

temp$grupo <- "Superior"
temp$grupo[temp$educa %in% c("INICIAL / PRE-ESCOLAR", "NINGUN NIVEL / ILETRADO")] <- "Ninguna"
temp$grupo[temp$educa %in% c("PRIMARIA COMPLETA", "PRIMARIA INCOMPLETA")] <- "Primaria"
temp$grupo[temp$educa %in% c("SECUNDARIA COMPLETA", "SECUNDARIA INCOMPLETA")] <- "Secundaria"

# Conteo semanal

ds <- docomp("count", "pais", c("semana", "grupo", "ano", "sexo"), dfr = temp, method = 'slow')

# Datos por año femenino

dc <- ds[ds$ano == 2020 & ds$sexo == "FEMENINO", c(1, 2, 5)]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019 & ds$sexo == "FEMENINO", c(1, 2, 5)]
colnames(temp)[3] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018 & ds$sexo == "FEMENINO", c(1, 2, 5)]
colnames(temp)[3] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Eliminar última semana

dc <- dc[dc$semana < max(dc$semana), ]

# Grafico

niveles <- c("Secundaria", "Superior", "Primaria", "Ninguna")
dc$Instrucción <- factor(dc$grupo, levels = niveles, ordered = TRUE)

ggplot(dc, aes(semana, ratio, colour = Instrucción)) +
  geom_point() +
  labs(x = "Semana",
       y = "Cociente entre el año 2020 y la media 2018-2019",
       title = "Número de fallecidos semanales a nivel nacional por causa no violenta
según nivel de instrucción - sexo femenino") + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

# Datos por año masculino

dc <- ds[ds$ano == 2020 & ds$sexo == "MASCULINO", c(1, 2, 5)]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019 & ds$sexo == "MASCULINO", c(1, 2, 5)]
colnames(temp)[3] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018 & ds$sexo == "MASCULINO", c(1, 2, 5)]
colnames(temp)[3] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Eliminar última semana

dc <- dc[dc$semana < max(dc$semana), ]

# Grafico

niveles <- c("Secundaria", "Superior", "Primaria", "Ninguna")
dc$Instrucción <- factor(dc$grupo, levels = niveles, ordered = TRUE)

ggplot(dc, aes(semana, ratio, colour = Instrucción)) +
  geom_point() +
  labs(x = "Semana",
       y = "Cociente entre el año 2020 y la media 2018-2019",
       title = "Número de fallecidos semanales a nivel nacional por causa no violenta
según nivel de instrucción - sexo masculino") + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr'))

```
