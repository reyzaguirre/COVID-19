---
title: "Seguimiento del número de fallecimientos diarios en el Perú"
subtitle: "Datos del Sistema Informático Nacional de Defunciones, SINADEF"
author: "Raúl Eyzaguirre"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: 
  html_document:
    toc: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

options(stringsAsFactors = FALSE)
options(digits = 4)

library(ggplot2)
library(ggrepel)
library(st4gi)
library(openxlsx) 
library(httr)
```

```{r descargar, include = FALSE}
url.sinadef <- "https://cloud.minsa.gob.pe/s/NctBnHXDnocgWAg/download?path=%2F&files=SINADEF_DATOS_ABIERTOS_10122020.xlsx"
GET(url.sinadef, write_disk("temp.xlsx", overwrite = TRUE))
```

```{r datos, include = FALSE}
full <- read.xlsx("temp.xlsx", sheet = 1, startRow = 4)
full <- full[, c("SEXO", "EDAD", "TIEMPO.EDAD", "NIVEL.DE.INSTRUCCIÓN", "PAIS.DOMICILIO",
                 "PROVINCIA.DOMICILIO", "DISTRITO.DOMICILIO", "FECHA", "AÑO", "MES",
                 "MUERTE.VIOLENTA")]
colnames(full) <- c("sexo", "edad", "unidad", "educa", "pais", "provincia",
                    "distrito", "fecha", "ano", "mes", "violenta")

# Formato fecha

full$fecha <- as.Date(full$fecha, "%Y-%m-%d")
full$mes <- as.numeric(full$mes)
full$ano <- as.numeric(full$ano)

# Codificar semanas

full$semana <- as.numeric(strftime(full$fecha, format = "%V"))

# Eliminar otros países

full <- full[full$pais == "PERU", ]

# Identificar último día (eliminar último día de registro)

ultimo.fecha <- max(full$fecha) - 1
ultimo.dia <- as.numeric(substr(ultimo.fecha, 9, 10))
ultimo.mes <- as.numeric(substr(ultimo.fecha, 6, 7))

lista.meses <- c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio",
                 "agosto", "septiembre", "octubre", "noviembre", "diciembre")

ultimo.mes.texto <- lista.meses[ultimo.mes]

ff <- data.frame(fecha = seq(as.Date("2020-01-01", "%Y-%m-%d"), ultimo.fecha, by = "day"),
                 pais = 0)

# Diferencias 2017, 2018, 2019

tt <- table(full$ano)
dif17.19 <- (tt[3] - tt[1]) / tt[3] * 100
dif18.19 <- (tt[3] - tt[2]) / tt[3] * 100

# Conteo por año y provincia

prov.ano <- table(full$provincia, full$ano)
chcy <- prov.ano[rownames(prov.ano) == "CHICLAYO", ]
ferr <- prov.ano[rownames(prov.ano) == "FERREÑAFE", ]
lamb <- prov.ano[rownames(prov.ano) == "LAMBAYEQUE", ]

# Datos hasta el último día de todos los años

full <- full[full$mes <= ultimo.mes, ]
full <- full[!(full$mes == ultimo.mes & as.numeric(substr(full$fecha, 9, 10)) > ultimo.dia), ]

# Juntar Lima y Callao

full$prov2 <- full$provincia
full$prov2[full$prov2 %in% c("CALLAO", "LIMA")] <- "LIMA Y CALLAO"

# Eliminar muerte violenta

full.nv <- full[full$violenta == "SIN REGISTRO", ]

# Totales por año

total <- table(full$ano)
total.nv <- table(full.nv$ano)

# Solo año 2020

nv.20 <- full.nv[full.nv$ano == 2020, ]

# Conteo diario provincia y año

ds <- docomp("count", "pais", c("ano", "prov2"), dfr = full.nv, method = 'slow')

# Calcular exceso acumulado 2020

ex <- ds[ds$ano == 2020, 2:3]
colnames(ex)[2] <- "total20"
temp <- ds[ds$ano == 2019, 2:3]
colnames(temp)[2] <- "total19"
ex <- merge(ex, temp)
temp <- ds[ds$ano == 2018, 2:3]
colnames(temp)[2] <- "total18"
ex <- merge(ex, temp)

# Aumentar primeros 90 días 2020 a la línea base

temp <- full.nv[full.nv$ano == 2020 & full.nv$fecha < "2020-03-31", ]
ds <- docomp("count", "pais", "prov2", dfr = temp, method = 'slow')
ds$pais <- ds$pais / 90 * as.numeric(ultimo.fecha - as.Date("2020-01-01"))
colnames(ds)[2] <- "ajust20"
ex <- merge(ex, ds, all.x = TRUE)

# Calcular linea base

ex$base <- (ex$ajust20 + ex$total19 + ex$total18) / 3

# Diferencia

ex$dif <- ex$total20 - ex$base

```

## 1. Introducción

Los datos del sistema Informático Nacional de Defunciones, SINADEF, pueden descargarse desde [este enlace](http://www.minsa.gob.pe/reunis/data/defunciones_registradas.asp) y cuentan con el registro de defunciones desde el año 2017. En la circunstancia actual, estos datos permiten evaluar el efecto de la epidemia de COVID-19 en el país. Es importante tener en cuenta que podría haber un efecto de cobertura (o falta de cobertura); esto se nota en los años 2017 y 2018 en donde el número de fallecidos es un `r paste0(format(dif17.19, digits = 3), "%")` y `r paste0(format(dif18.19, digits = 3), "%")` menor que en el 2019 respectivamente por lo que solo se utilizarán como referencia los datos del 2018 y el 2019. Para tratar de compensar el posible incremento en cobertura en el año 2020, se utilizará como línea base la media de los años 2018, 2019 y los primeros 90 días del 2020. Sobre el factor cobertura, si se considera una tasa de mortalidad para el país de un 5.6 por mil, el número de fallecidos registrados en Sinadef para los años 2018 y 2019 estaría entre un 62% y 64%.

### Problemas con los datos

Las provincias de Chiclayo, Ferreñafe y Lambayeque presentan una disminución considerable en el número de fallecidos con respecto al 2017. En la siguiente tabla se ve el número total de fallecidos en estas tres provincias en los años 2017, 2018 y 2019.

| Provincia  | Total fallecidos 2017 | Total fallecidos 2018 | Total fallecidos 2019 |
|:-----------|:---------------------:|:---------------------:|:---------------------:|
| Chiclayo   | `r chcy[1]`           |`r chcy[2]`            |`r chcy[3]`            |
| Ferreñafe  | `r ferr[1]`           |`r ferr[2]`            |`r ferr[3]`            |
| Lambayeque | `r lamb[1]`           |`r lamb[2]`            |`r lamb[3]`            |

## 2. Número total de fallecimientos por año

Los siguientes gráficos permiten evaluar el efecto COVID-19; el primero en el sentido más amplio pues incluye, entre otros factores:

- El incremento en el número de fallecimientos debido a COVID-19.
- El incremento en el número de fallecimientos debido a otras enfermedades que quedan desatendidas en el contexto actual.
- La disminución en el número de fallecimientos por causas violentas como los accidentes de tránsito.

El segundo gráfico no considera el posible efecto positivo en la disminución del número de muertes violentas.

```{r barras_total}

xx <- barplot(height = total,
              las = 1, xlab = "Año", ylim = c(0, max(total)*1.1),
              main = paste("Número de fallecidos registrados total a nivel nacional
hasta el", ultimo.dia, "de", ultimo.mes.texto))

text(x = xx, y = total, label = total, pos = 3, cex = 0.8)

```

La diferencia a la fecha entre este año y el 2019 es de `r total[4] - total[3]` para el número total de fallecidos.

```{r barras_nv}

xx <- barplot(height = total.nv,
              las = 1, xlab = "Año", ylim = c(0, max(total.nv)*1.1),
              main = paste("Número de fallecidos por causa no violenta registrados
a nivel nacional hasta el", ultimo.dia, "de", ultimo.mes.texto))

text(x = xx, y = total.nv, label = total.nv, pos = 3, cex = 0.8)

```

La diferencia a la fecha entre este año y el 2019 es de `r total.nv[4] - total.nv[3]` para el número de fallecidos por causa no violenta.

```{r barras_6_meses, eval = FALSE}

temp <- full[(full$fecha >= "2020-04-01" & full$fecha <= "2020-09-30") | (full$fecha >= "2019-04-01" & full$fecha <= "2019-09-30"), ]

total <- table(temp$ano)

xx <- barplot(height = total,
              las = 1, xlab = "Año", ylim = c(0, max(total)*1.1),
              main = "Número de fallecidos registrados total a nivel nacional
entre el 1 de abril hasta el 30 de septiembre")

text(x = xx, y = total, label = total, pos = 3, cex = 0.8)

```

## 3. Evolución del número de fallecidos diarios por causa no violenta en el 2020

Los siguientes gráficos permiten evaluar la evolución de la epidemia a través de su efecto en el número de fallecimientos diarios por causa no violenta, a nivel nacional y en las provincias con mayor población. En los gráficos se incluye el exceso de fallecidos este año con respecto a la media de los años 2018, 2019 y los primeros 70 días del 2020, expresado en número de fallecidos por mil habitantes y una marca para la fecha en la que se llegó a uno, dos tres y cuatro fallecidos en exceso por cada mil. Para la población total, en todos los casos se toma como referencia la población registrada en el [censo del 2017](https://es.wikipedia.org/wiki/Anexo:Provincias_del_Perú).

```{r tendencias}

## Total nacional

ds <- docomp("count", "pais", "fecha", dfr = nv.20, method = 'slow')

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Actual:",
               format((total.nv[4] - (total.nv[3] + total.nv[2] + sum(ex$ajust20, na.rm = TRUE)) / 3) / 31237.385, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios a nivel nacional por causa no violenta") +
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-06-20", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-11", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-12-08", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5) +

# ggplot(ds, aes(fecha, pais)) +
#   geom_point() +
#   labs(x = "Fecha", y = "Número de fallecidos diarios",
#        title = "Fallecidos diarios a nivel nacional por causa no violenta y pronóstico a 7 días") +
#   ylim(0, NA) +
#   xlim(as.Date.numeric(0, "2020-01-01"), as.Date.numeric(dim(ds)[1] + 7, "2020-01-01")) +
#   geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11), fullrange = TRUE, color = 2)

## Lima y Callao

temp <- nv.20[nv.20$provincia %in% c("CALLAO", "LIMA"), ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Línea roja: 4\n- Línea gris: 5\n- Actual:",
               format(ex[ex$prov2 == "LIMA Y CALLAO", "dif"] / 9569.468, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en las provincias de Lima y Callao por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1)  +
  geom_vline(xintercept = as.Date("2020-05-17", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-06-13", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-07-17", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-18", "%Y-%m-%d"), linetype = 2, color = 2, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-10-20", "%Y-%m-%d"), linetype = 2, color = 8, size = 1.5)

# ggplot(ds, aes(fecha, pais)) +
#   geom_point() +
#   labs(x = "Fecha", y = "Número de fallecidos diarios",
#        title = "Fallecidos diarios en las provincias de Lima y Callao por causa no violenta
#  y pronóstico a 7 días") + 
#   ylim(0, NA) +
#   xlim(as.Date.numeric(0, "2020-01-01"), as.Date.numeric(dim(ds)[1] + 7, "2020-01-01")) +
#   geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11), fullrange = TRUE, color = 2)

## Arequipa

temp <- nv.20[nv.20$provincia == "AREQUIPA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Línea roja: 4\n- Actual:",
               format(ex[ex$prov2 == "AREQUIPA", "dif"] / 1080.635, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Arequipa por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1)  +
  geom_vline(xintercept = as.Date("2020-07-04", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-07-21", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-07", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-10-08", "%Y-%m-%d"), linetype = 2, color = 2, size = 1.5)

## Trujillo

temp <- nv.20[nv.20$provincia == "TRUJILLO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Actual:",
               format(ex[ex$prov2 == "TRUJILLO", "dif"] / 970.016, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Trujillo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-06-17", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-07-06", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-06", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5)

## Chiclayo

temp <- nv.20[nv.20$provincia == "CHICLAYO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Chiclayo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

## Piura

temp <- nv.20[nv.20$provincia == "PIURA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Piura por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

## Huancayo

temp <- nv.20[nv.20$provincia == "HUANCAYO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "HUANCAYO", "dif"] / 545.615, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huancayo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1)  +
  geom_vline(xintercept = as.Date("2020-07-22", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-22", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Maynas

temp <- nv.20[nv.20$provincia == "MAYNAS", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Actual:",
               format(ex[ex$prov2 == "MAYNAS", "dif"] / 479.866, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Maynas por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-05-06", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-06-06", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-11-04", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5)

## Cusco

temp <- nv.20[nv.20$provincia == "CUSCO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "CUSCO", "dif"] / 447.588, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Cusco por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-08-13", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-09-24", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Santa

temp <- nv.20[nv.20$provincia == "SANTA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Línea roja: 4\n- Actual:",
               format(ex[ex$prov2 == "SANTA", "dif"] / 435.807, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Santa por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-05-23", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-06-15", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-07-20", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-10-14", "%Y-%m-%d"), linetype = 2, color = 2, size = 1.5)

## Ica

temp <- nv.20[nv.20$provincia == "ICA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Actual:",
               format(ex[ex$prov2 == "ICA", "dif"] / 391.519, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Ica por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-06-26", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-07-26", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-09-02", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5)

## Coronel Portillo

temp <- nv.20[nv.20$provincia == "CORONEL PORTILLO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "CORONEL PORTILLO", "dif"] / 384.168, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Coronel Portillo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-05-05", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-05-20", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Cajarmarca

temp <- nv.20[nv.20$provincia == "CAJAMARCA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "CAJAMARCA", "dif"] / 348.433, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Cajamarca por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-08-02", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-10-10", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Sullana

temp <- nv.20[nv.20$provincia == "SULLANA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Sullana por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

## San Román

temp <- nv.20[nv.20$provincia == "SAN ROMAN", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "SAN ROMAN", "dif"] / 307.417, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de San Román por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-08-18", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-11-28", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Tacna

temp <- nv.20[nv.20$provincia == "TACNA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Actual:",
               format(ex[ex$prov2 == "TACNA", "dif"] / 306.363, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Tacna por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-08-30", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5)

## Lambayeque

temp <- nv.20[nv.20$provincia == "LAMBAYEQUE", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Lambayeque por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

## Huanuco

temp <- nv.20[nv.20$provincia == "HUANUCO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Actual:",
               format(ex[ex$prov2 == "HUANUCO", "dif"] / 293.397, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huánuco por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-08-14", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5)

## Huamanga

temp <- nv.20[nv.20$provincia == "HUAMANGA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huamanga por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

## Cañete

temp <- nv.20[nv.20$provincia == "CAÑETE", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Cañete por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

## Huaura

temp <- nv.20[nv.20$provincia == "HUAURA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huaura por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

## Chincha

temp <- nv.20[nv.20$provincia == "CHINCHA", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Línea roja: 4\n- Línea gris: 5\n- Actual:",
               format(ex[ex$prov2 == "CHINCHA", "dif"] / 226.113, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Chincha por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1)  +
  geom_vline(xintercept = as.Date("2020-05-25", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-06-08", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-06-22", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-07-18", "%Y-%m-%d"), linetype = 2, color = 2, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-09-12", "%Y-%m-%d"), linetype = 2, color = 8, size = 1.5)

## Puno

temp <- nv.20[nv.20$provincia == "PUNO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "PUNO", "dif"] / 219.494, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Puno por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1)  +
  geom_vline(xintercept = as.Date("2020-08-15", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-10-10", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## San Martín

temp <- nv.20[nv.20$provincia == "SAN MARTIN", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "SAN MARTIN", "dif"] / 193.095, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de San Martín por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1)  +
  geom_vline(xintercept = as.Date("2020-06-28", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-09", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Huaral

temp <- nv.20[nv.20$provincia == "HUARAL", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "HUARAL", "dif"] / 183.898, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huaral por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1)  +
  geom_vline(xintercept = as.Date("2020-06-18", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-21", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Huaraz

temp <- nv.20[nv.20$provincia == "HUARAZ", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "HUARAZ", "dif"] / 163.936, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Huaraz por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-07-12", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-09", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Morropon

temp <- nv.20[nv.20$provincia == "MORROPON", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "MORROPON", "dif"] / 162.027, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Morropón por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-07-23", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-10-12", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Tumbes

temp <- nv.20[nv.20$provincia == "TUMBES", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Actual:",
               format(ex[ex$prov2 == "TUMBES", "dif"] / 154.962, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Tumbes por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-05-27", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-06-14", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-08-03", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5)

## Chanchamayo

temp <- nv.20[nv.20$provincia == "CHANCHAMAYO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Actual:",
               format(ex[ex$prov2 == "CHANCHAMAYO", "dif"] / 151.489, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Chanchamayo por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-08-02", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-11-17", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5)

## Pisco

temp <- nv.20[nv.20$provincia == "PISCO", ]
ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])

texto <- paste("Exceso en número de fallecidos\npor 1000 habitantes:\n- Línea azul: 1\n- Línea verde: 2\n- Línea naranja: 3\n- Actual:",
               format(ex[ex$prov2 == "PISCO", "dif"] / 150.744, digits = 4))

ggplot(ds, aes(fecha, pais)) +
  geom_point() +
  labs(x = "Fecha", y = "Número de fallecidos diarios",
       title = "Fallecidos diarios en la provincia de Pisco por causa no violenta") + 
  ylim(0, NA) +
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11)) +
  annotate(geom = "text", x = as.Date("2020-01-01", "%Y-%m-%d"), y = max(ds$pais),
           label = texto, size = 4.2, color = "darkblue", hjust = 0, vjust = 1) +
  geom_vline(xintercept = as.Date("2020-07-01", "%Y-%m-%d"), linetype = 2, color = 4, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-07-23", "%Y-%m-%d"), linetype = 2, color = 3, size = 1.5) +
  geom_vline(xintercept = as.Date("2020-09-02", "%Y-%m-%d"), linetype = 2, color = 7, size = 1.5)

```

## 4. Provincias y distritos con mayor incremento de fallecidos por causa no violenta en el último mes

En los siguientes gráficos se observan las 20 provincias y 40 distritos con mayor incremento de fallecimientos por causa no violenta en el último mes con respecto a la media del mismo periodo en el 2018 y 2019. Estos gráficos permiten identificar las provincias y distritos en los que la enfermedad podría haber avanzado más. Para evitar el efecto de muestras pequeñas, solo se consideran las provincias y distritos con un promedio de fallecimientos mensual mayor a 10 en la media del 2018 y 2019.

```{r provincias, fig.width = 7.5, fig.height = 5}

# Seleccionar ultimo mes

ultimo.fecha.18 <- as.Date(paste0("2018-", as.character(substr(ultimo.fecha, 6, 10))), "%Y-%m-%d")
ultimo.fecha.19 <- as.Date(paste0("2019-", as.character(substr(ultimo.fecha, 6, 10))), "%Y-%m-%d")
intervalo <- c((ultimo.fecha.18 - 30):ultimo.fecha.18,
               (ultimo.fecha.19 - 30):ultimo.fecha.19,
               (ultimo.fecha - 30):ultimo.fecha)
temp <- full.nv[full.nv$fecha %in% intervalo, ]

# Conteo diario provincia

ds <- docomp("count", "pais", c("ano", "prov2"), dfr = temp, method = 'slow')

# Datos por año

dc <- ds[ds$ano == 2020, 2:3]
colnames(dc)[2] <- "total20"
temp.p <- ds[ds$ano == 2019, 2:3]
colnames(temp.p)[2] <- "total19"
dc <- merge(dc, temp.p)
temp.p <- ds[ds$ano == 2018, 2:3]
colnames(temp.p)[2] <- "total18"
dc <- merge(dc, temp.p)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Ordenar y eliminar provincias con pocos habitantes

dc <- dc[dc$media1819 > 10, ]
dc <- dc[sort.int(dc$ratio, index.return = TRUE)$ix, ]
dc <- dc[(dim(dc)[1] - 19):dim(dc)[1], ]

# Grafico provincia

par(mar = c(4, 15, 2, 2) + 0.2)
barplot(height = dc$ratio, names.arg = dc$prov2, horiz = TRUE, las = 1,
        main = "Provincias con mayor incremento de fallecidos
en el último mes",
        xlab = "Cociente entre fallecidos por causa no violenta
en 2020 y la media 2018-2019 en el último mes")

```

```{r distritos, fig.width = 8, fig.height = 9}

# Conteo diario Distrito

ds <- docomp("count", "pais", c("ano", "distrito"), "provincia", dfr = temp, method = 'slow')
ds$distrito <- paste(ds$distrito, ds$provincia, sep = " / ")

# Datos por año

dc <- ds[ds$ano == 2020, 2:4]
colnames(dc)[3] <- "total20"
temp.p <- ds[ds$ano == 2019, 2:4]
colnames(temp.p)[3] <- "total19"
dc <- merge(dc, temp.p)
temp.p <- ds[ds$ano == 2018, 2:4]
colnames(temp.p)[3] <- "total18"
dc <- merge(dc, temp.p)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Ordenar y eliminar distritos con pocos habitantes

dc <- dc[dc$media1819 > 10, ]
dc <- dc[sort.int(dc$ratio, index.return = TRUE)$ix, ]
dc <- dc[(dim(dc)[1] - 39):dim(dc)[1], ]

# Grafico distrito

par(mar = c(4, 19, 2, 2) + 0.2)
barplot(height = dc$ratio, names.arg = dc$distrito, horiz = TRUE, las = 1,
        main = "Distritos con mayor incremento de fallecidos
en el último mes",
        xlab = "Cociente entre fallecidos por causa no violenta
en 2020 y la media 2018-2019 en el último mes")

```

```{r exceso}

#| Chiclayo         | `r ex[ex$prov2 == "CHICLAYO", "dif"] / 799675 * 1000` | 
#| Lambayeque       | `r ex[ex$prov2 == "LAMBAYEQUE", "dif"] / 300170 * 1000` | 
#| Pasco            | `r ex[ex$prov2 == "PASCO", "dif"] /	123015 * 1000` | 
#| Huaral           | `r ex[ex$prov2 == "HUARAL", "dif"] / 183898 * 1000` | 
#| San Martin       | `r ex[ex$prov2 == "SAN MARTIN", "dif"] / 193095 * 1000` | 
#| Pisco            | `r ex[ex$prov2 == "PISCO", "dif"] / 150744 * 1000` | 
#| Leoncio Prado    | `r ex[ex$prov2 == "LEONCIO PRADO", "dif"] / 127793 * 1000` | 
#| Jaen             | `r ex[ex$prov2 == "JAEN", "dif"] / 185432 * 1000` | 
#| Huaura           | `r ex[ex$prov2 == "HUAURA", "dif"] / 227685 * 1000` | 
#| Alto Amazonas    | `r ex[ex$prov2 == "ALTO AMAZONAS", "dif"] /	122725 * 1000` | 
#| Cañete           | `r ex[ex$prov2 == "CAÑETE", "dif"] / 240013 * 1000` | 
#| Huaraz           | `r ex[ex$prov2 == "HUARAZ", "dif"] / 163936 * 1000` | 
#| Chanchamayo      | `r ex[ex$prov2 == "CHANCHAMAYO", "dif"] / 151489 * 1000` | 
#| Huánuco          | `r ex[ex$prov2 == "HUANUCO", "dif"] / 293397 * 1000` | 
#| Ascope           | `r ex[ex$prov2 == "ASCOPE", "dif"] / 115786 * 1000` | 
#| Chincha          | `r ex[ex$prov2 == "CHINCHA", "dif"] / 226113 * 1000` | 
#| Tumbes           | `r ex[ex$prov2 == "TUMBES", "dif"] / 154962 * 1000` |
#| Tambopata        | `r ex[ex$prov2 == "TAMBOPATA", "dif"] / 111474 * 1000` | 
#| Paita            | `r ex[ex$prov2 == "PAITA", "dif"] / 129892 * 1000` | 
#| Sullana          | `r ex[ex$prov2 == "SULLANA", "dif"] / 311454 * 1000` | 

```

## 5. Efecto COVID-19 y altura

En el siguiente gráfico se observa la relación entre el exceso en el número de fallecidos con respecto a la media del 2018, 2019 y primeros 70 días del 2020, en casos por 1000 habitantes para las provincias más pobladas con la excepción de Chiclayo y Lambayeque (por las razones expuestas en la sección 1 de este documento) y la altitud de la ciudad más poblada de la provincia.

```{r altura}

prov <- c("Lima y Callao", "Arequipa", "Trujillo", "Huancayo", "Maynas", "Cusco",
          "Santa", "Ica", "Coronel Portillo", "Cajamarca", "San Román", "Tacna",
          "Huánuco", "Chincha", "Puno", "Satipo", "San Martín", "Huaral", "Huaraz",
          "Morropón", "Tumbes", "Chanchamayo", "Pisco", "Abancay")
exce <- c(ex[ex$prov2 == "LIMA Y CALLAO", "dif"] / 9569468 * 1000,
          ex[ex$prov2 == "AREQUIPA", "dif"] / 1080635 * 1000,
          ex[ex$prov2 == "TRUJILLO", "dif"] / 970016 * 1000,
          ex[ex$prov2 == "HUANCAYO", "dif"] / 545615 * 1000,
          ex[ex$prov2 == "MAYNAS", "dif"] / 479866 * 1000,
          ex[ex$prov2 == "CUSCO", "dif"] / 447588 * 1000,
          ex[ex$prov2 == "SANTA", "dif"] / 435807 * 1000,
          ex[ex$prov2 == "ICA", "dif"] / 391519 * 1000,
          ex[ex$prov2 == "CORONEL PORTILLO", "dif"] / 384168 * 1000,
          ex[ex$prov2 == "CAJAMARCA", "dif"] / 348433 * 1000,
          ex[ex$prov2 == "SAN ROMAN", "dif"] / 307417 * 1000,
          ex[ex$prov2 == "TACNA", "dif"] / 306363 * 1000,
          ex[ex$prov2 == "HUANUCO", "dif"] / 293397 * 1000,
          ex[ex$prov2 == "CHINCHA", "dif"] / 226113 * 1000,
          ex[ex$prov2 == "PUNO", "dif"] / 219494 * 1000,
          ex[ex$prov2 == "SATIPO", "dif"] / 203985 * 1000,
          ex[ex$prov2 == "SAN MARTIN", "dif"] / 193095 * 1000,
          ex[ex$prov2 == "HUARAL", "dif"] / 183898 * 1000,
          ex[ex$prov2 == "HUARAZ", "dif"] / 163936 * 1000,
          ex[ex$prov2 == "MORROPON", "dif"] / 162027 * 1000,
          ex[ex$prov2 == "TUMBES", "dif"] / 154962 * 1000,
          ex[ex$prov2 == "CHANCHAMAYO", "dif"] / 151489 * 1000,
          ex[ex$prov2 == "PISCO", "dif"] / 150744 * 1000,
          ex[ex$prov2 == "ABANCAY", "dif"] / 110520 * 1000)
alti <- c(161, 2335, 34, 3246, 105, 3399, 5, 406, 154, 2750, 3824, 562, 1898,
          97, 3810, 631, 350, 188, 3052, 92, 6, 751, 17, 2500)

temp <- data.frame(provincia = prov,
                   exceso = exce,
                   altitud = alti)
temp <- temp[temp$exceso > -0.25, ]

ggplot(temp, aes(altitud, exceso)) +
  geom_point() +
  labs(x = "Altitud de la ciudad más poblada (m s.n.m.)",
       y = "Exceso de fallecidos por 1000 habitantes",
       title = "Exceso de fallecidos por 1000 habitantes para el año 2020
para las provincias más pobladas con relación a su altitud") + 
  geom_text_repel(label = temp$provincia) +
  geom_smooth(method = "lm", se = FALSE)

```

## 6. Evolución del número de fallecidos por causa no violenta en el 2020 por sexo, edad, y nivel de instrucción

Se sabe que la letalidad de COVID-19 es mayor en hombres que en mujeres y que se incrementa considerablemente con la edad. Se observa también diferencias entre grupos con diferente nivel de instrucción, aunque este efecto podría estar confundido con el sexo, la edad y la zona de residencia (urbano o rural). Los siguientes gráficos permiten evaluar el efecto de la epidemia por sexo, edad y nivel de instrucción en el Perú.

```{r sexo}

# Limpiar solo hombres y mujeres

temp <- full.nv[full.nv$sexo == "FEMENINO" | full.nv$sexo == "MASCULINO", ]

# Conteo diario

ds <- docomp("count", "pais", c("fecha", "sexo"), "ano", dfr = temp, method = 'slow')

# Formato

ds$mes <- substr(as.character(ds$fecha), 6, 7)
ds$dia <- substr(as.character(ds$fecha), 9, 10)

# Datos por año

dc <- ds[ds$ano == 2020, -3]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019, c(2, 4, 5, 6)]
colnames(temp)[2] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018, c(2, 4, 5, 6)]
colnames(temp)[2] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Diferencia y ratio

dc$dif <- dc$total20 - dc$media1819
dc$ratio <- dc$total20 / dc$media1819

# Grafico

dc$sexo[dc$sexo == "MASCULINO"] <- "Masculino"
dc$sexo[dc$sexo == "FEMENINO"] <- "Femenino"

niveles <- c("Masculino", "Femenino")
dc$Sexo <- factor(dc$sexo, levels = niveles, ordered = TRUE)

ggplot(dc, aes(fecha, ratio, colour = Sexo)) +
  geom_point() +
  labs(x = "Fecha",
       y = "Cociente entre el año 2020 y la media 2018-2019",
       title = "Número de fallecidos diarios a nivel nacional por causa no violenta según sexo") + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

```

```{r edad}

# Limpiar solo edad en anos

temp.e <- full.nv[full.nv$unidad == "AÑOS" & full.nv$edad != "SIN REGISTRO", ]
temp.e$edad <- as.numeric(temp.e$edad)

# Grupos para tendencia

temp.e$grupo <- "75 y más"
temp.e$grupo[temp.e$edad < 75] <- "65 a 74"
temp.e$grupo[temp.e$edad < 65] <- "55 a 64"
temp.e$grupo[temp.e$edad < 55] <- "45 a 54"
temp.e$grupo[temp.e$edad < 45] <- "35 a 44"
temp.e$grupo[temp.e$edad < 35] <- "0 a 35"

# Conteo por semana

ds <- docomp("count", "pais", c("semana", "grupo", "ano"), dfr = temp.e, method = 'fast')

# Datos por año

dc <- ds[ds$ano == 2020, -3]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019, c(1, 2, 4)]
colnames(temp)[3] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018, c(1, 2, 4)]
colnames(temp)[3] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Eliminar última semana

dc <- dc[dc$semana < max(dc$semana), ]

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Grafico

niveles <- c("75 y más", "65 a 74", "55 a 64", "45 a 54", "35 a 44", "0 a 35")

dc$`Grupo de edad` <- factor(dc$grupo, levels = niveles, ordered = TRUE)

ggplot(dc, aes(semana, ratio, colour = `Grupo de edad`)) +
  geom_point() +
  labs(x = "Semana",
       y = "Cociente entre el año 2020 y la media 2018-2019",
       name = "Grupo de Edad",
       title = "Número de fallecidos semanales a nivel nacional por causa no violenta
según grupo de edad") + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

```

```{r riesgo}

# Limpiar solo hombres y mujeres

temp.e <- temp.e[temp.e$sexo == "FEMENINO" | temp.e$sexo == "MASCULINO", ]

# Grupos para mortalidad

temp.e$grupo <- "80 y más"
temp.e$grupo[temp.e$edad < 80] <- "75 a 79"
temp.e$grupo[temp.e$edad < 75] <- "70 a 74"
temp.e$grupo[temp.e$edad < 70] <- "65 a 69"
temp.e$grupo[temp.e$edad < 65] <- "60 a 64"
temp.e$grupo[temp.e$edad < 60] <- "55 a 59"
temp.e$grupo[temp.e$edad < 55] <- "50 a 54"
temp.e$grupo[temp.e$edad < 50] <- "45 a 49"
temp.e$grupo[temp.e$edad < 45] <- "40 a 44"
temp.e$grupo[temp.e$edad < 40] <- "35 a 39"
temp.e$grupo[temp.e$edad < 35] <- "30 a 34"
temp.e$grupo[temp.e$edad < 30] <- "25 a 29"
temp.e$grupo[temp.e$edad < 25] <- "20 a 24"
temp.e$grupo[temp.e$edad < 20] <- "15 a 19"
temp.e$grupo[temp.e$edad < 15] <- "0 a 14"

temp.e$grupo <- factor(temp.e$grupo, ordered = TRUE,
                       levels = c("0 a 14", "15 a 19", "20 a 24", "25 a 29", "30 a 34",
                                  "35 a 39", "40 a 44", "45 a 49", "50 a 54", "55 a 59",
                                  "60 a 64", "65 a 69", "70 a 74", "75 a 79", "80 y más"))

# Conteo por grupo y sexo

ds <- docomp("count", "pais", c("sexo", "grupo", "ano"), dfr = temp.e, method = 'fast')

# Datos por año

dc <- ds[ds$ano == 2020, -3]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019, c(1, 2, 4)]
colnames(temp)[3] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018, c(1, 2, 4)]
colnames(temp)[3] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Exceso

dc$dif <- dc$total20 - dc$media1819

# Totales

dc$total <- c(1385933 + 1417319 + 1430083, 1420257, 1401017, 1344048, 1233884, 1145477,
              1034343, 903752, 788241, 658490, 532940, 415647, 311231, 229221, 235076,
              1445122 + 1473968 + 1483727, 1466289, 1438000, 1371191, 1251238, 1156915,
              1038422, 899326, 774590, 634510, 501128, 379352, 271687, 186805, 166789)

# Ratio

dc$ratio <- dc$dif / dc$total

# Grafico

dc$grupo2 <- as.numeric(dc$grupo)

ggplot(dc, aes(grupo, ratio, colour = sexo)) +
  geom_point() +
  geom_line(aes(grupo2)) +  
  labs(x = "Edad (en años)",
       y = "Proporción de fallecidos",
       name = "Sexo",
       title = "Estimación de la proporción de fallecidos por COVID-19 según sexo y edad") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))

```

```{r instrucción}

# Limpiar solo instrucción definida

temp <- full.nv[!(full.nv$educa == "IGNORADO" | full.nv$educa == "SIN REGISTRO"), ]

# Grupos

temp$grupo <- "Superior"
temp$grupo[temp$educa %in% c("INICIAL / PRE-ESCOLAR", "NINGUN NIVEL / ILETRADO")] <- "Ninguna"
temp$grupo[temp$educa %in% c("PRIMARIA COMPLETA", "PRIMARIA INCOMPLETA")] <- "Primaria"
temp$grupo[temp$educa %in% c("SECUNDARIA COMPLETA", "SECUNDARIA INCOMPLETA")] <- "Secundaria"

# Conteo semanal

ds <- docomp("count", "pais", c("semana", "grupo", "ano", "sexo"), dfr = temp, method = 'slow')

# Datos por año femenino

dc <- ds[ds$ano == 2020 & ds$sexo == "FEMENINO", c(1, 2, 5)]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019 & ds$sexo == "FEMENINO", c(1, 2, 5)]
colnames(temp)[3] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018 & ds$sexo == "FEMENINO", c(1, 2, 5)]
colnames(temp)[3] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Eliminar última semana

dc <- dc[dc$semana < max(dc$semana), ]

# Grafico

niveles <- c("Superior", "Secundaria", "Primaria", "Ninguna")

dc$Instrucción <- factor(dc$grupo, levels = niveles, ordered = TRUE)

ggplot(dc, aes(semana, ratio, colour = Instrucción)) +
  geom_point() +
  labs(x = "Semana",
       y = "Cociente entre el año 2020 y la media 2018-2019",
       title = "Número de fallecidos semanales a nivel nacional por causa no violenta
según nivel de instrucción - sexo femenino") + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

# Datos por año masculino

dc <- ds[ds$ano == 2020 & ds$sexo == "MASCULINO", c(1, 2, 5)]
colnames(dc)[3] <- "total20"
temp <- ds[ds$ano == 2019 & ds$sexo == "MASCULINO", c(1, 2, 5)]
colnames(temp)[3] <- "total19"
dc <- merge(dc, temp)
temp <- ds[ds$ano == 2018 & ds$sexo == "MASCULINO", c(1, 2, 5)]
colnames(temp)[3] <- "total18"
dc <- merge(dc, temp)

# Calcular media 2018 2019

dc$media1819 <- (dc$total19 + dc$total18) / 2

# Ratio

dc$ratio <- dc$total20 / dc$media1819

# Eliminar última semana

dc <- dc[dc$semana < max(dc$semana), ]

# Grafico

dc$Instrucción <- factor(dc$grupo, levels = niveles, ordered = TRUE)

ggplot(dc, aes(semana, ratio, colour = Instrucción)) +
  geom_point() +
  labs(x = "Semana",
       y = "Cociente entre el año 2020 y la media 2018-2019",
       title = "Número de fallecidos semanales a nivel nacional por causa no violenta
según nivel de instrucción - sexo masculino") + 
  geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = 11))

```
