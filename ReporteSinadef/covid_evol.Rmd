---
title: "Evolución del número de fallecimientos diarios en el Perú"
subtitle: "Datos del Sistema Informático Nacional de Defunciones, SINADEF"
author: "Raúl Eyzaguirre"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: 
  html_document:
    toc: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

options(stringsAsFactors = FALSE)
options(digits = 4)

library(ggplot2)
library(st4gi)
library(openxlsx) 
library(httr)
```

```{r descargar, include = FALSE}
url.sinadef <- "https://cloud.minsa.gob.pe/s/NctBnHXDnocgWAg/download?path=%2F&files=SINADEF_DATOS_ABIERTOS.xlsx"
GET(url.sinadef, write_disk("temp.xlsx", overwrite = TRUE))
```

```{r datos, include = FALSE}
full <- read.xlsx("temp.xlsx")
full <- full[, c("PAIS.DOMICILIO", "DEPARTAMENTO.DOMICILIO", "PROVINCIA.DOMICILIO",
                 "DISTRITO.DOMICILIO", "FECHA", "AÑO")]
colnames(full) <- c("pais", "departamento", "provincia", "distrito", "fecha", "ano")

# Totales por año

total <- table(full$ano)

# Formato fecha

full$fecha <- as.Date(full$fecha, "%Y-%m-%d")
full$ano <- as.numeric(full$ano)

# A partir del 2020 y hasta un día antes

full <- full[full$fecha >= "2020-01-01" & full$fecha < max(full$fecha), ]

# Identificar último día

ultimo.fecha <- max(full$fecha) - 1
ultimo.dia <- as.numeric(substr(ultimo.fecha, 9, 10))
ultimo.mes <- as.numeric(substr(ultimo.fecha, 6, 7))

lista.meses <- c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio",
                 "agosto", "septiembre", "octubre", "noviembre", "diciembre")

ultimo.mes.texto <- lista.meses[ultimo.mes]

# Eliminar otros paises

full <- full[full$pais == "PERU", ]

# Todas las fechas

ultimo.fecha <- max(full$fecha)
ff <- data.frame(fecha = seq(as.Date("2020-01-01", "%Y-%m-%d"), ultimo.fecha, by = "day"), pais = 0)
```

## 1. Introducción

Los datos del sistema Informático Nacional de Defunciones, SINADEF, pueden descargarse desde [este enlace](http://www.minsa.gob.pe/reunis/data/defunciones_registradas.asp) y cuentan con el registro de defunciones desde el año 2017. En la circunstancia actual, estos datos permiten evaluar el efecto de la epidemia de COVID-19 en el país. Es importante tener en cuenta que podría haber un efecto de cobertura (o falta de cobertura); si se considera una tasa de mortalidad para el país de un 5.6 por mil, el número de fallecidos registrados en Sinadef para los años 2017, 2018 y 2019 sería del 54.2%, 61.8% y 62.9%, respectivamente. Este subregistro no es igual en todas las provincias; como referencia, en los gráficos siguientes se coloca una linea verde indicando el nivel correspondiente a un registro al 100% con una tasa de mortalidad de 5.6 por mil y una línea roja indicando el promedio observado en los primeros 3 meses del 2020. Esta línea roja se utiliza como base para calcular el exceso de muerte.

## 2. Evolución del número de fallecidos diarios a nivel nacional

```{r doplot}
doplot <- function(titulo, subtitulo = NULL, k = 20, poblacion, exceso = FALSE) {
  ds <- docomp("count", "pais", "fecha", dfr = temp, method = 'slow')
  ds <- rbind(ds, ff[!(ff$fecha %in% ds$fecha), ])
  if(exceso) {
    lb <- sum(ds$pais[ds$fecha <= "2020-03-31"]) / 91
    ds$dif <- ds$pais - lb
    subtitulo = paste("Exceso con respecto a la línea roja:", round(sum(ds$dif)))
  }
  p <- ggplot(ds, aes(fecha, pais)) +
    geom_point() +
    labs(x = "Fecha", y = "Número de fallecidos diarios",
         title = titulo, subtitle = subtitulo) +
    ylim(0, NA) +
    geom_smooth(method = 'gam', formula = y ~ s(x, bs = 'cr', k = k)) +
    geom_hline(yintercept = poblacion * 0.0056 / 365, linetype = 2, color = 3, size = 1)
  if(exceso) {
    p <- p +
      geom_hline(yintercept = lb, linetype = 2, color = 2, size = 1)
  }
  p
}
```

```{r peru}
temp <- full
doplot(titulo = paste("Fallecidos diarios a nivel nacional hasta el", ultimo.dia, "de", ultimo.mes.texto),
       poblacion = 32625948,
       exceso = TRUE)
```

## 3. Evolución del número de fallecidos diarios por departamento

```{r departamento}
## Amazonas

temp <- full[full$departamento == "AMAZONAS", ]
doplot(titulo = "Fallecidos diarios en el departamento de Amazonas",
       poblacion = 426806)

## Ancash

temp <- full[full$departamento == "ANCASH", ]
doplot(titulo = "Fallecidos diarios en el departamento de Áncash",
       poblacion = 1180638,
       exceso = TRUE)

## Apurimac

temp <- full[full$departamento == "APURIMAC", ]
doplot(titulo = "Fallecidos diarios en el departamento de Apurimac",
       poblacion = 430736)

## Arequipa

temp <- full[full$departamento == "AREQUIPA", ]
doplot(titulo = "Fallecidos diarios en el departamento de Arequipa",
       poblacion = 1497438,
       exceso = TRUE)

## Ayacucho

temp <- full[full$departamento == "AYACUCHO", ]
doplot(titulo = "Fallecidos diarios en el departamento de Ayacucho",
       poblacion = 668213)

## Cajamarca

temp <- full[full$departamento == "CAJAMARCA", ]
doplot(titulo = "Fallecidos diarios en el departamento de Cajamarca",
       poblacion = 1435711)

## Cusco

temp <- full[full$departamento == "CUSCO", ]
doplot(titulo = "Fallecidos diarios en el departamento de Cusco",
       poblacion = 1357075)

## Huancavelica

temp <- full[full$departamento == "HUANCAVELICA", ]
doplot(titulo = "Fallecidos diarios en el departamento de Huancavelica",
       poblacion = 365317)

## Huánuco

temp <- full[full$departamento == "HUANUCO", ]
doplot(titulo = "Fallecidos diarios en el departamento de Huánuco",
       poblacion = 760267)

## Ica

temp <- full[full$departamento == "ICA", ]
doplot(titulo = "Fallecidos diarios en el departamento de Ica",
       poblacion = 975182,
       exceso = TRUE)

## Junín

temp <- full[full$departamento == "JUNIN", ]
doplot(titulo = "Fallecidos diarios en el departamento de Junín",
       poblacion = 1361467)

## La Libertad

temp <- full[full$departamento == "LA LIBERTAD", ]
doplot(titulo = "Fallecidos diarios en el departamento de La Libertad",
       poblacion = 2016771)

## Lambayeque

temp <- full[full$departamento == "LAMBAYEQUE", ]
doplot(titulo = "Fallecidos diarios en el departamento de Lambayeque",
       poblacion = 1310785)

## Lima

temp <- full[full$departamento %in% c("CALLAO", "LIMA"), ]
doplot(titulo = "Fallecidos diarios en el departamento de Lima",
       poblacion = (10628470 + 1129854),
       exceso = TRUE)

## Loreto

temp <- full[full$departamento == "LORETO", ]
doplot(titulo = "Fallecidos diarios en el departamento de Loreto",
       poblacion = 1027559)

## Madre de Dios

temp <- full[full$departamento == "MADRE DE DIOS", ]
doplot(titulo = "Fallecidos diarios en el departamento de Madre de Dios",
       poblacion = 173811)

## Moquegua

temp <- full[full$departamento == "MOQUEGUA", ]
doplot(titulo = "Fallecidos diarios en el departamento de Moquegua",
       poblacion = 192740)

## Pasco

temp <- full[full$departamento == "PASCO", ]
doplot(titulo = "Fallecidos diarios en el departamento de Pasco",
       poblacion = 271904)

## Piura

temp <- full[full$departamento == "PIURA", ]
doplot(titulo = "Fallecidos diarios en el departamento de Piura",
       poblacion = 2047954)

## Puno

temp <- full[full$departamento == "PUNO", ]
doplot(titulo = "Fallecidos diarios en el departamento de Puno",
       poblacion = 1237997)

## San Martín

temp <- full[full$departamento == "SAN MARTIN", ]
doplot(titulo = "Fallecidos diarios en el departamento de San Martín",
       poblacion = 899648)

## Tacna

temp <- full[full$departamento == "TACNA", ]
doplot(titulo = "Fallecidos diarios en el departamento de Tacna",
       poblacion = 370974)

## Tumbes

temp <- full[full$departamento == "TUMBES", ]
doplot(titulo = "Fallecidos diarios en el departamento de Tumbes",
       poblacion = 251521)

## Ucayali

temp <- full[full$departamento == "UCAYALI", ]
doplot(titulo = "Fallecidos diarios en el departamento de Ucayali",
       poblacion = 589110)
```

## 4. Evolución del número de fallecidos diarios por provincia (más de 140000 habitantes)

```{r provincia}
## Andahuaylas

temp <- full[full$provincia == "ANDAHUAYLAS", ]
doplot(titulo = "Fallecidos diarios en la provincia de Andahuaylas (Apurimac)",
       poblacion = 142477)

## Arequipa

temp <- full[full$provincia == "AREQUIPA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Arequipa (Arequipa)",
       poblacion = 1080635)

## Barranca

temp <- full[full$provincia == "BARRANCA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Barranca (Lima)",
       poblacion = 144381)

## Cajamarca

temp <- full[full$provincia == "CAJAMARCA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Cajamarca (Cajamarca)",
       poblacion = 348433)

## Callao

temp <- full[full$provincia == "CALLAO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Callao (Lima)",
       poblacion = 994494)

## Cañete

temp <- full[full$provincia == "CAÑETE", ]
doplot(titulo = "Fallecidos diarios en la provincia de Cañete (Lima)",
       poblacion = 240013)

## Chanchamayo

temp <- full[full$provincia == "CHANCHAMAYO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Chanchamayo (Junin)",
       poblacion = 151489)

## Chiclayo

temp <- full[full$provincia == "CHICLAYO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Chiclayo (Lambayeque)",
       poblacion = 799675)

## Chincha

temp <- full[full$provincia == "CHINCHA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Chincha (Ica)",
       poblacion = 226113)

## Chota

temp <- full[full$provincia == "CHOTA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Chota (Cajamarca)",
       poblacion = 142984)

## Coronel Portillo

temp <- full[full$provincia == "CORONEL PORTILLO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Coronel Portillo (Ucayali)",
       poblacion = 384168)

## Cusco

temp <- full[full$provincia == "CUSCO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Cusco (Cusco)",
       poblacion = 447588)

## Huacho

temp <- full[full$provincia == "HUAURA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Huaura (Lima)",
       poblacion = 227685)

## Huamanga

temp <- full[full$provincia == "HUAMANGA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Huamanga (Ayacucho)",
       poblacion = 282194)

## Huancayo

temp <- full[full$provincia == "HUANCAYO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Huancayo (Junin)",
       poblacion = 545615)

## Huánuco

temp <- full[full$provincia == "HUANUCO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Huánuco (Huánuco)",
       poblacion = 293397)

## Huaral

temp <- full[full$provincia == "HUARAL", ]
doplot(titulo = "Fallecidos diarios en la provincia de Huaral (Lima)",
       poblacion = 183898)

## Huaraz

temp <- full[full$provincia == "HUARAZ", ]
doplot(titulo = "Fallecidos diarios en la provincia de Huaraz (Ancash)",
       poblacion = 163936)

## Ica

temp <- full[full$provincia == "ICA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Ica (Ica)",
       poblacion = 391519)

## Jaén

temp <- full[full$provincia == "JAEN", ]
doplot(titulo = "Fallecidos diarios en la provincia de Jaén (Cajamarca)",
       poblacion = 185432)

## La Convención
 
temp <- full[full$provincia == "LA CONVENCION", ]
doplot(titulo = "Fallecidos diarios en la provincia de La Convención (Cusco)",
       poblacion = 147148)

## Lambayeque

temp <- full[full$provincia == "LAMBAYEQUE", ]
doplot(titulo = "Fallecidos diarios en la provincia de Lambayeque (Lambayeque)",
       poblacion = 391519)

## Lima

temp <- full[full$provincia == "LIMA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Lima (Lima)",
       poblacion = 8574974)

## Maynas

temp <- full[full$provincia == "MAYNAS", ]
doplot(titulo = "Fallecidos diarios en la provincia de Maynas (Loreto)",
       poblacion = 479866)

## Morropón

temp <- full[full$provincia == "MORROPON", ]
doplot(titulo = "Fallecidos diarios en la provincia de Morropón (Piura)",
       poblacion = 162027)

## Pisco

temp <- full[full$provincia == "PISCO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Pisco (Ica)",
       poblacion = 150744)

## Piura

temp <- full[full$provincia == "PIURA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Piura (Piura)",
       poblacion = 799321)

## Puno

temp <- full[full$provincia == "PUNO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Puno (Puno)",
       poblacion = 219494)

# ## San Ignacio
# 
# temp <- full[full$provincia == "SAN IGNACIO", ]
# doplot(titulo = "Fallecidos diarios en la provincia de San Ignacio (Cajamarca)",
#        poblacion = 130620)

## San Martín

temp <- full[full$provincia == "SAN MARTIN", ]
doplot(titulo = "Fallecidos diarios en la provincia de San Martín (San Martín)",
       poblacion = 193095)

## San Román

temp <- full[full$provincia == "SAN ROMAN", ]
doplot(titulo = "Fallecidos diarios en la provincia de San Román (Puno)",
       poblacion = 307417)

# ## Sánchez Carrión
 
temp <- full[full$provincia == "SANCHEZ CARRION", ]
doplot(titulo = "Fallecidos diarios en la provincia de Sánchez Carrión (La Libertad)",
       poblacion = 144405)

## Santa

temp <- full[full$provincia == "SANTA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Santa (Ancash)",
       poblacion = 435807)

## Satipo

temp <- full[full$provincia == "SATIPO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Satipo (Junín)",
       poblacion = 203985)

## Sullana

temp <- full[full$provincia == "SULLANA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Sullana (Piura)",
       poblacion = 311454)

## Tacna

temp <- full[full$provincia == "TACNA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Tacna (Tacna)",
       poblacion = 306363)

## Talara

temp <- full[full$provincia == "TALARA", ]
doplot(titulo = "Fallecidos diarios en la provincia de Talara (Piura)",
       poblacion = 144150)

## Trujillo

temp <- full[full$provincia == "TRUJILLO", ]
doplot(titulo = "Fallecidos diarios en la provincia de Trujillo (La Libertad)",
       poblacion = 970016)

## Tumbes

temp <- full[full$provincia == "TUMBES", ]
doplot(titulo = "Fallecidos diarios en la provincia de Tumbes (Tumbes)",
       poblacion = 154962)
```
